// Dentro lo script alla fine del body

document.addEventListener('DOMContentLoaded', function() {
  const filterInput = document.getElementById('ginocchio-filter');
  const grid = document.getElementById('ginocchi-grid');
  const categoryButtons = document.querySelectorAll('#category-filters .filter-btn');
  const commandSuggestion = document.getElementById('command-suggestion');

  // Verifica iniziale degli elementi
  if (!filterInput || !grid || !categoryButtons.length || !commandSuggestion) {
    console.error("Elementi essenziali per filtri/galleria mancanti.");
    return; // Esce se manca qualcosa
  }

  const thumbnails = grid.querySelectorAll('.ginocchio-thumbnail');
  const chatbotIframe = document.getElementById('chatbot-iframe');
  let suggestionTimeout;
  let activeCategory = 'tutti'; // Memorizza categoria attiva

  // --- Funzione Filtro Categoria ---
  categoryButtons.forEach(button => {
    button.addEventListener('click', function() {
      // Aggiorna stato bottone attivo
      categoryButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');

      activeCategory = this.getAttribute('data-categoria');

      // Applica filtro categoria E resetta filtro nome
      filterInput.value = ''; // Pulisce la ricerca per nome
      applyFilters();
    });
  });

  // --- Funzione Filtro Nome ---
  filterInput.addEventListener('input', function() {
    applyFilters(); // Applica entrambi i filtri quando si digita
  });

  // --- Funzione Combinata per Applicare Filtri ---
  function applyFilters() {
      const nameFilterText = filterInput.value.toLowerCase().trim();

      thumbnails.forEach(function(thumb) {
          const nomeGinocchio = thumb.getAttribute('data-nome').toLowerCase();
          const categoriaGinocchio = thumb.getAttribute('data-categoria');

          // 1. Controllo Categoria
          const isInActiveCategory = (activeCategory === 'tutti' || categoriaGinocchio === activeCategory);

          // 2. Controllo Nome (solo se categoria corrisponde)
          const matchesName = nomeGinocchio.includes(nameFilterText);

          // Mostra solo se appartiene alla categoria attiva E corrisponde al filtro nome
          if (isInActiveCategory && matchesName) {
              // Usiamo classi separate per evitare conflitti
              thumb.classList.remove('hidden-by-category', 'hidden-by-name');
          } else {
              // Nasconde se non è nella categoria o non corrisponde al nome
              if (!isInActiveCategory) {
                thumb.classList.add('hidden-by-category');
                thumb.classList.remove('hidden-by-name'); // Rimuovi l'altra classe se nascosto per categoria
              } else { // Se è nella categoria ma non matcha il nome
                thumb.classList.remove('hidden-by-category');
                thumb.classList.add('hidden-by-name');
              }
          }
      });
  }

  // --- Funzione Click Miniatura (Invariata nella logica base) ---
  thumbnails.forEach(function(thumb) {
    thumb.addEventListener('click', function() {
      if(this.classList.contains('hidden-by-category') || this.classList.contains('hidden-by-name')) {
        return; // Non fare nulla se l'elemento è nascosto dai filtri
      }
      const nomeGinocchio = this.getAttribute('data-nome');
      const comando = `Parla con ${nomeGinocchio}`;

      // Copia e mostra guida (come prima)
      if (navigator.clipboard) {
        navigator.clipboard.writeText(comando).then(() => {
          commandSuggestion.innerHTML = `Comando <code>${comando}</code> copiato! Incolla nella chat.`;
          commandSuggestion.classList.add('visible');
          clearTimeout(suggestionTimeout);
          suggestionTimeout = setTimeout(() => { commandSuggestion.classList.remove('visible'); }, 4000);
        }).catch(err => {
          commandSuggestion.innerHTML = `Scrivi <code>${comando}</code> nella chat!`;
          commandSuggestion.classList.add('visible');
          clearTimeout(suggestionTimeout); suggestionTimeout = setTimeout(() => { commandSuggestion.classList.remove('visible'); }, 4000);
          console.error('Errore copia:', err);
        });
      } else {
         commandSuggestion.innerHTML = `Scrivi <code>${comando}</code> nella chat!`;
         commandSuggestion.classList.add('visible');
         clearTimeout(suggestionTimeout); suggestionTimeout = setTimeout(() => { commandSuggestion.classList.remove('visible'); }, 4000);
      }
      // Scroll
      if (chatbotIframe) { chatbotIframe.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    });
  });

  // Applica filtro iniziale (mostra tutti)
  applyFilters();

});
</script>
